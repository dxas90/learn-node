suite: test httproute
templates:
  - httproute.yaml
tests:
  - it: should create HTTPRoute when enabled
    set:
      httproute.enabled: true
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: metadata.name
          value: RELEASE-NAME-learn-node

  - it: should not create HTTPRoute when disabled
    set:
      httproute.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should include custom annotations
    set:
      httproute.enabled: true
    asserts:
      - equal:
          path: metadata.annotations["networking.x-k8s.io/route-shard"]
          value: example
      - equal:
          path: metadata.annotations["cert-manager.io/cluster-issuer"]
          value: letsencrypt-production

  - it: should include custom labels
    set:
      httproute.enabled: true
    asserts:
      - equal:
          path: metadata.labels["use-cloudflare-solver"]
          value: "true"

  - it: should configure gateway reference
    set:
      httproute.enabled: true
    asserts:
      - contains:
          path: spec.parentRefs
          content:
            name: traefik-gateway
            namespace: networking
            sectionName: websecure

  - it: should configure hostnames
    set:
      httproute.enabled: true
    asserts:
      - contains:
          path: spec.hostnames
          content: learn-node.example.com

  - it: should configure backend service
    set:
      httproute.enabled: true
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 3000
