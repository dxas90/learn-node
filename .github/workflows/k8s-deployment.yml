name: Kubernetes Deployment Pipeline

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  APP_NAME: learn-node
  CLUSTER_NAME: test-cluster

jobs:
  helm-test:
    name: Helm Chart Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install Helm unittest plugin
        run: helm plugin install https://github.com/helm-unittest/helm-unittest.git

      - name: Run Helm unit tests
        run: helm unittest k8s/learn-node

      - name: Lint Helm chart
        run: helm lint k8s/learn-node

  test-deployment:
    name: Test Kubernetes Deployment
    runs-on: ubuntu-latest
    needs: helm-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Setup Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          kubectl_version: v1.28.4
          verbosity: 1

      - name: Load Docker image into Kind
        run: |
          # Build the image
          docker build -t ${{ env.APP_NAME }}:test .
          # Load image into Kind cluster
          kind load docker-image ${{ env.APP_NAME }}:test --name ${{ env.CLUSTER_NAME }}

      - name: Wait for cluster to be ready
        run: |
          echo "Waiting for nodes to be ready..."
          kubectl wait --for=condition=Ready nodes --all --timeout=300s
          echo "Cluster is ready!"

      - name: Display cluster information
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo "=== Nodes ==="
          kubectl get nodes -o wide
          echo "=== Pods (all namespaces) ==="
          kubectl get pods --all-namespaces -o wide
          echo "=== Services (all namespaces) ==="
          kubectl get services --all-namespaces -o wide

      - name: Deploy application using Helm
        run: |
          echo "Deploying application with Helm..."
          helm upgrade --install ${{ env.APP_NAME }} ./k8s/learn-node \
            --set image.repository=${{ env.APP_NAME }} \
            --set image.tag=test \
            --set image.pullPolicy=Never \
            --set replicaCount=2 \
            --set httproute.enabled=false \
            --wait \
            --timeout 5m \
            --debug

          echo "=== Helm Release Status ==="
          helm status ${{ env.APP_NAME }}

          echo "=== Deployment Status ==="
          kubectl get deployments
          kubectl get pods -l app.kubernetes.io/name=learn-node
          kubectl get services

      - name: Test application endpoints
        run: |
          echo "Testing application endpoints..."

          # Port forward to access the service
          kubectl port-forward service/${{ env.APP_NAME }} 8080:8080 &
          PF_PID=$!
          sleep 10

          # Test health endpoint
          echo "Testing /healthz endpoint..."
          curl -f http://localhost:8080/healthz || exit 1

          # Test ping endpoint
          echo "Testing /ping endpoint..."
          curl -f http://localhost:8080/ping || exit 1

          # Test main endpoint
          echo "Testing / endpoint..."
          curl -f http://localhost:8080/ || exit 1

          echo "All endpoints are working correctly!"

          # Kill port-forward
          kill $PF_PID || true

      - name: Show application logs
        if: always()
        run: |
          echo "=== Application Logs ==="
          kubectl logs -l app.kubernetes.io/name=learn-node --tail=50

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up resources..."
          helm uninstall ${{ env.APP_NAME }} --ignore-not-found || true

  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: test-deployment
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.learn-node.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Deploy to staging with Helm
        run: |
          echo "Deploying to staging Kubernetes cluster using Helm..."
          # Configure kubectl context for staging
          # kubectl config use-context staging-cluster

          # Deploy using Helm
          helm upgrade --install ${{ env.APP_NAME }} ./k8s/learn-node \
            --namespace staging \
            --create-namespace \
            --set image.repository=ghcr.io/${{ github.repository }} \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --set replicaCount=2 \
            --set httproute.enabled=true \
            --set httproute.hostnames[0]=staging.learn-node.example.com \
            --wait \
            --timeout 10m \
            --debug

          echo "=== Deployment Status ==="
          helm status ${{ env.APP_NAME }} -n staging

  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: test-deployment
    if: startsWith(github.ref, 'refs/tags/')
    environment:
      name: production
      url: https://learn-node.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Deploy to production with Helm
        run: |
          echo "Deploying to production Kubernetes cluster using Helm..."
          # Configure kubectl context for production
          # kubectl config use-context production-cluster

          # Deploy using Helm
          helm upgrade --install ${{ env.APP_NAME }} ./k8s/learn-node \
            --namespace production \
            --create-namespace \
            --set image.repository=ghcr.io/${{ github.repository }} \
            --set image.tag=v${{ steps.version.outputs.VERSION }} \
            --set image.pullPolicy=Always \
            --set replicaCount=3 \
            --set autoscaling.enabled=true \
            --set autoscaling.minReplicas=3 \
            --set autoscaling.maxReplicas=10 \
            --set httproute.enabled=true \
            --set httproute.hostnames[0]=learn-node.example.com \
            --set resources.limits.memory=512Mi \
            --set resources.requests.cpu=200m \
            --set resources.requests.memory=128Mi \
            --wait \
            --timeout 15m \
            --debug

          echo "=== Deployment Status ==="
          helm status ${{ env.APP_NAME }} -n production

          echo "=== Rollout History ==="
          helm history ${{ env.APP_NAME }} -n production
